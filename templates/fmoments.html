<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{modules/layouts/layout :: layout(content = ~{::content}, htmlType = 'page',title = 'æœ‹å‹åœˆ | ' + ${site.title}, head = ~{::head})}">

<th:block th:fragment="head">
    <th:block th:replace="~{modules/common/open-graph :: open-graph(_title = 'æœ‹å‹åœˆ',
                _permalink = '/moments',
                _cover = '',
                _excerpt = 'å‹é“¾æœ‹å‹åœˆ - å‘ç°æ›´å¤šç²¾å½©å†…å®¹',
                _type = 'website')}"></th:block>
    <!-- åˆ†ç¦»CSSæ–‡ä»¶ -->
    <link rel="stylesheet" th:href="@{/assets/css/fmoments.css}" data-pjax>
</th:block>

<th:block th:fragment="content">
    <div class="page" id="body-wrap">
        <!-- å¤´éƒ¨å¯¼èˆªæ  -->
        <header class="not-top-img" id="page-header">
            <nav th:replace="~{modules/nav :: nav(title = 'æœ‹å‹åœˆ')}"></nav>
        </header>

        <main class="layout hide-aside" id="content-inner">
            <div id="page">
                <!-- æœ‹å‹åœˆç»Ÿè®¡ä¿¡æ¯é¢æ¿ -->
                <div id="fMomentsMessageBoard">
                    <div class="fMomentsUpdatedTime">
                        <i class="fas fa-sync-alt"></i>
                        æœ€è¿‘æ›´æ–°ï¼š<span id="lastUpdateTime">åŠ è½½ä¸­...</span>
                    </div>

                    <div class="fMomentsStatsGrid">
                        <div class="fMomentsStatCard">
                            <div class="fMomentsStatIcon">ğŸ“š</div>
                            <div class="fMomentsStatNumber" id="totalArticles">0</div>
                            <div class="fMomentsStatLabel">æ€»æ–‡ç« æ•°</div>
                        </div>

                        <div class="fMomentsStatCard">
                            <div class="fMomentsStatIcon">ğŸ‘¥</div>
                            <div class="fMomentsStatNumber" id="totalAuthors">0</div>
                            <div class="fMomentsStatLabel">æ´»è·ƒä½œè€…</div>
                        </div>

                        <div class="fMomentsStatCard">
                            <div class="fMomentsStatIcon">ğŸ”¥</div>
                            <div class="fMomentsStatNumber" id="todayCount">0</div>
                            <div class="fMomentsStatLabel">ä»Šæ—¥æ›´æ–°</div>
                        </div>

                        <div class="fMomentsStatCard">
                            <div class="fMomentsStatIcon">âš¡</div>
                            <div class="fMomentsStatNumber" id="weekCount">0</div>
                            <div class="fMomentsStatLabel">æœ¬å‘¨æ›´æ–°</div>
                        </div>
                    </div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="fMomentsControlPanel">
                    <div class="fMomentsSearchBox">
                        <i class="fas fa-search fMomentsSearchIcon"></i>
                        <input type="text" class="fMomentsSearchInput" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–ä½œè€…..." id="searchInput">
                    </div>

                    <div class="fMomentsFilterGroup">
                        <select class="fMomentsSelect" id="authorFilter">
                            <option value="">å…¨éƒ¨ä½œè€…</option>
                        </select>

                        <select class="fMomentsSelect" id="sortSelect">
                            <option value="pubDate">æŒ‰å‘å¸ƒæ—¶é—´</option>
                            <option value="creationTime">æŒ‰åˆ›å»ºæ—¶é—´</option>
                            <option value="author">æŒ‰ä½œè€…åç§°</option>
                            <option value="title">æŒ‰æ ‡é¢˜</option>
                        </select>

                        <div class="fMomentsToggle">
                            <span>å‡åº</span>
                            <div class="fMomentsSwitch active" id="sortOrderSwitch"></div>
                            <span>é™åº</span>
                        </div>
                    </div>
                </div>

                <!-- æ˜¾ç¤ºæ•°é‡çŠ¶æ€ -->
                <div class="fMomentsDisplayStatus">
                    <div class="fMomentsDisplayInfo">
                        <i class="fas fa-filter"></i>
                        <span>æ˜¾ç¤º</span>
                        <span class="fMomentsDisplayCount" id="displayedCount">0</span>
                        <span>/</span>
                        <span class="fMomentsDisplayCount" id="totalCount">0</span>
                        <span>ç¯‡æ–‡ç« </span>
                    </div>
                    <div class="fMomentsDisplayInfo" id="filterStatus" style="display: none;">
                        <i class="fas fa-info-circle"></i>
                        <span id="filterText">å·²åº”ç”¨ç­›é€‰æ¡ä»¶</span>
                    </div>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div id="loadingIndicator" class="fMomentsLoading">
                    <div class="fMomentsLoadingSpinner"></div>
                    <div class="fMomentsLoadingText">æ­£åœ¨åŠ è½½åŠ¨æ€å†…å®¹...</div>
                </div>

                <!-- æœ‹å‹åœˆæ–‡ç« å®¹å™¨ -->
                <div id="fmomentsContainer"></div>

                <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
                <div id="loadingStatus" style="display: none;">
                    <button id="fmomentsMoreBtn" type="button">
                        <i class="fas fa-angle-double-down"></i>
                        <span>åŠ è½½æ›´å¤š</span>
                    </button>
                    <div class="fMomentsNoMore" id="noMoreTip" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                        <div>ğŸ‰ å·²æ˜¾ç¤ºå…¨éƒ¨å†…å®¹</div>
                        <small>å…±æ‰¾åˆ° <span id="finalCount">0</span> ç¯‡æ–‡ç« </small>
                    </div>
                </div>

                <!-- é”™è¯¯çŠ¶æ€ -->
                <div class="fMomentsErrorState" id="errorState" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>åŠ è½½å¤±è´¥</h3>
                    <div id="errorMessage">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</div>
                    <button class="fMomentsRetryBtn" id="retryBtn">é‡æ–°åŠ è½½</button>
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div class="fMomentsEmptyState" id="emptyState" style="display: none;">
                    <i class="fas fa-search"></i>
                    <h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </h3>
                    <p>å°è¯•æ›´æ¢æœç´¢è¯æˆ–è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨ -->
        <footer th:replace="~{modules/footer}" />

        <!-- èµ„æºæ£€æŸ¥å’ŒåŠ¨æ€åŠ è½½è„šæœ¬ -->
        <script data-pjax th:inline="javascript">
            // èµ„æºåŠ¨æ€åŠ è½½å™¨
            window.MomentsResourceLoader = {
                // æ£€æŸ¥CSSæ˜¯å¦å·²åŠ è½½
                isCSSLoaded: function (href) {
                    const links = document.getElementsByTagName('link');
                    for (let i = 0; i < links.length; i++) {
                        if (links[i].href && links[i].href.includes(href)) {
                            return true;
                        }
                    }
                    return false;
                },

                // æ£€æŸ¥JSæ˜¯å¦å·²åŠ è½½
                isJSLoaded: function (src) {
                    const scripts = document.getElementsByTagName('script');
                    for (let i = 0; i < scripts.length; i++) {
                        if (scripts[i].src && scripts[i].src.includes(src)) {
                            return true;
                        }
                    }
                    // ä¹Ÿæ£€æŸ¥æ˜¯å¦å·²ç»å®šä¹‰äº†ç›¸å…³çš„å…¨å±€å˜é‡/å‡½æ•°
                    return typeof FriendMomentsApp !== 'undefined';
                },

                // åŠ¨æ€åŠ è½½CSS
                loadCSS: function (href) {
                    return new Promise((resolve, reject) => {
                        if (this.isCSSLoaded(href)) {
                            console.log('CSS already loaded:', href);
                            resolve();
                            return;
                        }

                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = href;
                        link.setAttribute('data-pjax', '');

                        link.onload = () => {
                            console.log('CSS loaded successfully:', href);
                            resolve();
                        };

                        link.onerror = () => {
                            console.error('Failed to load CSS:', href);
                            reject(new Error(`Failed to load CSS: ${href}`));
                        };

                        document.head.appendChild(link);
                    });
                },

                // åŠ¨æ€åŠ è½½JS
                loadJS: function (src) {
                    return new Promise((resolve, reject) => {
                        if (this.isJSLoaded(src)) {
                            console.log('JS already loaded:', src);
                            resolve();
                            return;
                        }

                        const script = document.createElement('script');
                        script.src = src;
                        script.setAttribute('data-pjax', '');

                        script.onload = () => {
                            console.log('JS loaded successfully:', src);
                            resolve();
                        };

                        script.onerror = () => {
                            console.error('Failed to load JS:', src);
                            reject(new Error(`Failed to load JS: ${src}`));
                        };

                        document.head.appendChild(script);
                    });
                },

                // åŠ è½½æ‰€æœ‰å¿…éœ€çš„èµ„æº
                loadRequiredResources: async function () {
                    const cssPath = /*[[@{/assets/css/fmoments.css}]]*/ '/assets/css/fmoments.css';
                    const jsPath = /*[[@{/assets/js/fmoments.js}]]*/ '/assets/js/fmoments.js';

                    try {
                        console.log('Checking and loading required resources...');

                        // å¹¶è¡ŒåŠ è½½CSSå’ŒJS
                        await Promise.all([
                            this.loadCSS(cssPath),
                            this.loadJS(jsPath)
                        ]);

                        console.log('All resources loaded successfully');
                        return true;
                    } catch (error) {
                        console.error('Error loading resources:', error);
                        return false;
                    }
                }
            };
        </script>
        <!-- åˆå§‹åŒ–è„šæœ¬ -->
        <script data-pjax th:inline="javascript">
            // æœ‹å‹åœˆé…ç½®
            // ä»ä¸»é¢˜è®¾ç½®è·å–
            window.fmomentsConfig = {
                apiUrl: /*[[${theme.config.link.fmomentsApiUrl}]]*/ '/apis/api.friend.moony.la/v1alpha1/friendposts',
                pageSize: /*[[${theme.config.link.fmomentsPageSize}]]*/ 12,
                errorImg: /*[[${theme.config.other.error_404.background}]]*/ '/assets/images/404.gif'
            };

            // å…¨å±€åˆå§‹åŒ–çŠ¶æ€è¿½è¸ª
            window._momentsInitializing = false;

            // åˆå§‹åŒ–æœ‹å‹åœˆåº”ç”¨
            async function initMomentsApp() {
                // é˜²æ­¢å¹¶å‘åˆå§‹åŒ–
                if (window._momentsInitializing) {
                    console.log('Moments initialization already in progress');
                    return;
                }

                console.log('Starting Moments initialization');
                window._momentsInitializing = true;

                try {
                    // é¦–å…ˆæ£€æŸ¥å¹¶åŠ è½½å¿…éœ€çš„èµ„æº
                    const resourcesLoaded = await window.MomentsResourceLoader.loadRequiredResources();

                    if (!resourcesLoaded) {
                        console.error('Failed to load required resources');
                        return;
                    }

                    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿èµ„æºå®Œå…¨åŠ è½½
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // æ£€æŸ¥FriendMomentsAppæ˜¯å¦å¯ç”¨
                    if (typeof FriendMomentsApp !== 'undefined') {
                        // åˆ›å»ºæ–°å®ä¾‹ï¼ˆæ„é€ å‡½æ•°ä¼šå¤„ç†æ—§å®ä¾‹çš„æ¸…ç†ï¼‰
                        window.fMomentsApp = new FriendMomentsApp();
                        // æ˜¾å¼è°ƒç”¨åˆå§‹åŒ–
                        await window.fMomentsApp.init();
                        console.log('FriendMomentsApp initialized successfully');
                    } else {
                        console.error('FriendMomentsApp is not available after loading resources');
                    }
                } catch (error) {
                    console.error('Error initializing FriendMomentsApp:', error);
                } finally {
                    window._momentsInitializing = false;
                }
            }

            // PJAXå¼€å§‹æ—¶ç«‹å³æ¸…ç†
            document.addEventListener('pjax:start', function () {
                console.log('PJAX start - cleaning up Moments');
                if (window._momentsInstance) {
                    window._momentsInstance.destroy();
                }
                window._momentsInitializing = false;
            });

            // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initMomentsApp);
            } else {
                // DOMå·²ç»åŠ è½½å®Œæˆ
                initMomentsApp();
            }

            // PJAXå®Œæˆåé‡æ–°åˆå§‹åŒ–
            document.addEventListener('pjax:complete', function () {
                if (document.getElementById('fmomentsContainer')) {
                    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMç¨³å®š
                    setTimeout(initMomentsApp, 150);
                }
            });
        </script>

    </div>
</th:block>

</html>